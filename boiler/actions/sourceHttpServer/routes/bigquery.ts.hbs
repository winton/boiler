import http from "http"
import url from "url"

import { BigQueryBuffer } from "bigquery-buffer"
import pino from "pino"

export class BigQueryRoute {
  constructor(
    private log: pino.Logger,
    private buffer: BigQueryBuffer
  ) {}

  match(req: http.IncomingMessage): boolean {
    return req.url.startsWith("/bq.gif?")
  }

  async route(
    req: http.IncomingMessage,
    res: http.ServerResponse
  ): Promise<void> {
    const { query } = url.parse(req.url, true)

    if (this.buffer) {
      await this.buffer.push(query)
    } else {
      this.log.info({ "DEV MODE BUFFER PUSH": query })
    }

    res.writeHead(204, {
      "Cache-Control": "private, no-cache, no-store",
      "Content-Length": 0,
      "Content-Type": "image/gif",
    })
  }
}
